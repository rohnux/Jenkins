stages:
    - build-with-scan
    - check

build-with-scan:
    only:
      refs:
        - merge_requests
      variables:
        - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
        - $CI_MERGE_REQUEST_EVENT_TYPE == "merged_result"

    stage: build-with-scan
    script:
        - mvn -Dmaven.repo.local=/cache -f pom.xml clean install
        - /tmp/sonar-scanner-2.8/bin/sonar-scanner -Dsonar.login=$SONAR_TOKEN -Dsonar.projectKey=dev-eks-pipeline -Dsonar.projectName=dev-eks-pipeline -Dsonar.profile=skyflow -Dsonar.qualitygate=Dev-Env -Dsonar.projectVersion=1.0 -Dsonar.sources=. -Dsonar.java.libraries=/tmp/lombok-1.18.4.jar -Dsonar.exclusions=**/jacoco-resources/**,**/config/**,**/domain/**,**/domain/dto/**,**/config/**,**/exception/**,**/converter/**,**/hystrix-dashboard/**,**/turbine/**,**/constant/**,**/entity/**,**/*ContractVerifierTest.java,**/*Event_orchestratorTest.java -Dsonar.tests=. -Dsonar.junit.reportsPath=demo-core/target/surefire-reports -Dsonar.surefire.reportsPath=demo-adapter/target/surefire-reports,demo-core/target/surefire-reports,demo-deploy/target/surefire-reports,event-orchestrator-parent/event-orchestrator-core/target/surefire-reports,event-orchestrator-parent/event-orchestrator-adapter/target/surefire-reports -Dsonar.jacoco.reportPaths=demo-adapter/target/jacoco-output/merged.exec,demo-core/target/jacoco-output/merged.exec,demo-processor/target/jacoco-output/merged.exec,demo-deploy/target/jacoco-output/merged.exec,event-orchestrator-parent/event-orchestrator-core/target/jacoco-output/merged.exec,event-orchestrator-parent/event-orchestrator-adapter/target/jacoco-output/merged.exec -Dsonar.java.binaries=**/target/classes -Dsonar.java.coveragePlugin=jacoco -Dsonar.test.exclusions=**/src/main/java/** -Dsonar.test.inclusions=**/src/test/java/**
    artifacts:
        paths:
            - tmp/build

check:
    only:
      refs:
        - merge_requests
      variables:
        - $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "dev"
        - $CI_MERGE_REQUEST_EVENT_TYPE == "merged_result"
    stage: check
    script:
        - echo "this stage must run for all"
